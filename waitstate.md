# ウェイトステート

## ウェイトステート

メモリのアクセスにはウェイトステートがない方が望ましいです。 つまり、`1N`と`1S`はそれぞれ1クロックサイクルに等しくなるべきです。

しかし、時間のかかるカートリッジへのアクセスやデータバス幅が小さいメモリ領域に対しての(32bit)アクセスは、1クロックサイクルでは完了しません。

そのため、CPUはアクセス時間を考慮して、自発的に待機する必要があります。この待機時間のことをウェイトステートと呼びます。

どれくらいのウェイトステートが必要かは、アクセス対象のバスクロックによるため、GBAでは`WAITCNT`というレジスタでウェイトステートを設定することが可能です。

## 0x0400_0204 - WAITCNT - ウェイトステート制御レジスタ (R/W)

カートリッジのROMは `0x0800_0000`, `0x0A00_0000`, `0x0C00_0000` の3つのアドレス領域にミラーリングされており、これらの領域にCPUがアクセスするのに要する時間を WaitState0, WaitState1, WaitState2 と呼びます。

それぞれの領域に異なるウェイトステートを割り当てることができます。

```
  Bit     Expl.
  0-1     SRAMウェイトステート (0..3 = 4,3,2,8 cycles)
  2-3     N0 - WaitState0 ノンシーケンシャルアクセス (0..3 = 4,3,2,8 cycles)
  4       S0 - WaitState0 シーケンシャルアクセス (0..1 = 2,1 cycles)
  5-6     N1 - WaitState1 ノンシーケンシャルアクセス (0..3 = 4,3,2,8 cycles)
  7       S1 - WaitState1 シーケンシャルアクセス (0..1 = 4,1 cycles)
  8-9     N2 - WaitState2 ノンシーケンシャルアクセス (0..3 = 4,3,2,8 cycles)
  10      S2 - WaitState2 シーケンシャルアクセス (0..1 = 8,1 cycles)
  11-12   PHI Terminal Output (0..3 = Disable, 4.19MHz, 8.38MHz, 16.78MHz)
  13      不使用
  14      カートリッジのプリフェッチが有効かどうか (0=無効, 1=有効)
  15      Game Pak Type Flag (Read Only) (0=GBA, 1=CGB) (IN35 signal)
  16-31   不使用
```

`WAITCNT`は起動時には`0x0000_0000`です。

そしてその後、現在製造されているカートリッジでは `WAITCNT=0x0000_4317=0b0000_0000_0000_0000_0100_0011_0001_0111` となります。これは

```
  SRAM:        8サイクル
  N0, N1, N2:  3, 4, 8サイクル
  S0, S1, S2:  1, 4, 8サイクル
```

となります。 実際のカートリッジのアクセスにはこれに1サイクル加えたものがアクセスに要するサイクルになります。(SRAMはそのまま8サイクル)

また、カートリッジのデータバスは16bitなので、32bitアクセスは2回の16bitアクセスに分割されて行われます。 最初の16bitがノンシーケンシャルであっても、2回目の16bitは常にシーケンシャルです

注意: GBAはカートリッジROMの各128Kブロックの先頭にアクセスする際には強制的にノンシーケンシャルアクセスします。 またPHI端子出力(Gamepak BusのPHIピン)は無効にしてください。
