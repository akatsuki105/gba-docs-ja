# DMA転送

ダイレクトメモリアクセス（DMA）は、CPUを介さずにデータを高速に転送する方法です。

データのコピー(転送)だけでなく、メモリ埋め(Fill)にも使用できます。

DMAを有効にすると、転送時にはCPUが一時停止して、DMAコントローラが必要な転送を行い、転送が終わるとCPUが動作を再開します。

GBAには4つのDMAチャンネルがあり、優先度は `DMA0 > DMA1 > DMA2 > DMA3` となっています。優先度の低いDMAチャンネルは、優先度の高いチャンネルが完了するまで一時停止されます。

DMA転送がアクティブなときはCPUは一時停止しますが、`Sound/Blanking DMA転送`が一時停止している間はCPUは動作しています。

## それぞれのチャンネルの役割

```
  DMA0:     HBlank期間内のデータ転送(HBlank DMA)など、時間にシビアな転送をしたいとき(優先度が最も高いため)
  DMA1, 2:  サウンド再生時のFIFOにデータを転送するとき。内部メモリ・外部メモリから内部メモリへの転送が可能。
  DMA3:     Game Pak ROM/FlashROMに書き込みをするとき(SRAMは除く)
```

加えて、全部のDMAチャンネルは**汎用的なデータ転送用途**にも使うことができます。

## SAD - ソースレジスタ (W)

DMA転送で転送するデータが始まるアドレスを指定します。

```
0x0400_00B0 & 0x0400_00B2 - DMA0SAD - DMA0ソースレジスタ (内部メモリのみ)
0x0400_00BC & 0x0400_00BE - DMA1SAD - DMA1ソースレジスタ 
0x0400_00C8 & 0x0400_00CA - DMA2SAD - DMA2ソースレジスタ 
0x0400_00D4 & 0x0400_00D6 - DMA3SAD - DMA3ソースレジスタ 
```

DMA0の場合は`0x07ff_ffff`まで、DMA1,DMA2,DMA3の場合は`0x0fff_ffff`まで指定することが可能です。

## DAD - ターゲットレジスタ (W)

DMA転送でデータ転送先のアドレスを指定します。

```
0x0400_00B4 & 0x0400_00B6 - DMA0DAD - DMA0ターゲットレジスタ (内部メモリのみ)
0x0400_00C0 & 0x0400_00C2 - DMA1DAD - DMA1ターゲットレジスタ (内部メモリのみ)
0x0400_00CC & 0x0400_00CE - DMA2DAD - DMA2ターゲットレジスタ (内部メモリのみ)
0x0400_00D8 & 0x0400_00DA - DMA3DAD - DMA3ターゲットレジスタ
```

DMA0, DMA1, DMA2の場合は`0x07ff_ffff`まで、DMA3の場合は`0x0fff_ffff`まで指定することが可能です。

## CNT_L - ワードカウントレジスタ (W)

CNTの下位16bitです。

```
0x0400_00B8 - DMA0CNT_L - DMA0ワードカウント (14 bit, 0x1..0x4000)
0x0400_00C4 - DMA1CNT_L - DMA1ワードカウント (14 bit, 0x1..0x4000)
0x0400_00D0 - DMA2CNT_L - DMA2ワードカウント (14 bit, 0x1..0x4000)
0x0400_00DC - DMA3CNT_L - DMA3ワードカウント (16 bit, 0x1..0x10000)
```

一度に転送されるデータのサイズを指定するためのレジスタです。 転送タイプによって1ワードカウントで16bit(2byte)転送するのか32bit(4byte)転送するのかが変わります。

0を入れた場合最大値(`0x4000` or `0x10000`)として扱われます。

## CNT_H - 制御レジスタ (R/W)

CNTの上位16bitです。

```
0x0400_00BA - DMA0CNT_H - DMA0制御レジスタ
0x0400_00C6 - DMA1CNT_H - DMA1制御レジスタ
0x0400_00D2 - DMA2CNT_H - DMA2制御レジスタ
0x0400_00DE - DMA3CNT_H - DMA3制御レジスタ
```

 bit | 内容 | 備考
---- | ---- | ---- 
0-4 | 未使用 | --
5-6 | ターゲットアドレス制御 | 0=Increment,1=Decrement,2=Fixed,3=Increment/Reload
7-8 | ソースアドレス制御 | 0=Increment,1=Decrement,2=Fixed,3=Prohibited
9 | DMAリピート | 1=On, bit11が1の場合必ず0
10 | DMA転送タイプ | 0=16bit, 1=32bit
11 | Game Pak DRQ(DMA3のみ) | 0=Normal, 1=DRQ from Game Pak, DMA3
12-13 | 転送モード(DMA開始タイミング) | 0=即座に, 1=VBlank時, 2=HBlank時, 3=特殊<sup>[1](#dma_mode)</sup>
14 | IRQフラグ | 1の場合、転送終了(ワードカウント分転送した)ときにIRQを起こす
15 | DMA有効フラグ | 0=無効, 1=有効

<sup id="dma_mode">1: DMAチャンネルごとに異なります。 DMA0=Prohibited, DMA1/DMA2=Sound FIFO, DMA3=Video Capture</sup>

DMA有効フラグ(bit15)を0から1に変更した後、DMA関連レジスタにアクセスする前に2クロックサイクル待つ必要があります。

HBlankタイミングでOAM(`0x0700_0000`)やOBJ VRAM(`0x0601_0000`)にアクセスする場合は、DISPCNTレジスタの "H-Blank Interval Free"ビットをセットする必要があります。

## ソースレジスタ、ターゲットレジスタ、ワードカウントレジスタ

ソースレジスタ、ターゲットレジスタ、ワードカウントレジスタは初期開始アドレスと初期長を保持しています。ハードウェアは転送中または転送後にこれらのレジスタの内容を変更することは**ありません**。

実際の転送は、**プログラマからは触れない**、内部ポインタと内部カウンタレジスタを使用して行われます。初期値は次の2つの場合に内部レジスタにコピーされます

- DMA有効フラグ(bit15)を0から1に変更したとき: SAD, DAD, CNT_L がリロードされます。
- DMAリピート時: CNT_Lがリロードされます。DADは`Increment/Reload`のときにリロードされます。

## DMAリピートビット(CNT_H.9)

一度のDMA転送が終了したあとに次回のDMA転送を繰り返し行うか行わないかの設定です。 

- クリアされている場合: 転送終了すると、DMA有効フラグは自動的にクリアされます。
- セットされている場合: 転送終了後もDMA有効フラグはセットされたままで、転送開始タイミング（例：HBlank）になるたびに転送が再開されます。

転送では、毎回ワードカウントレジスタで指定された分のデータを転送します。転送はソフトウェアで停止するまで永遠に繰り返されます。

## サウンドDMA (DMA1/DMA2のみ)

サウンド再生用のFIFOへのDMA転送のことをサウンドDMAと呼びます。

サウンドDMAを行う場合は上述のリピートビットをONにし、転送先アドレスをFIFO_A（`0x0400_00a0`）またはFIFO_B（`0x0400_00a4`）に設定する必要があります。

サウンドコントローラからのDMA要求により、32bitを4回（合計16バイト）転送します。 このとき、ワードカウントレジスタとDMA転送タイプビット(`CNT_H.10`)は無視されます。サウンドDMAでは転送先アドレスはインクリメントされません。

DMA0のような、サウンドDMAより優先度の高いDMAチャンネルの動作中は、サウンドDMAが一時停止されることに注意してください。例えば、サウンドのサンプルレートが64kHzの場合、16バイトのサウンドDMAデータが 0.25ms(4kHz)ごとに要求されます。よって0.25ms経過するまでに次の16バイトをサウンドDMAでFIFOに転送する必要があります。
つまり、サウンドDMAより優先度の高いDMA転送は、0.25ms以内に終わるのが望ましいです。とはいえ、HBlankの時間は16.212usに制限されているため、DMA0をHBlank時のデータ転送として使う限り問題にはなりません。

## Game Pak DMA

>**Warning** 信頼性低

DMA3 のみが Game Pak ROM または Flash ROM との間のデータ転送に使用されます。<sup>[1](#sram)</sup>

通常モードでは、ワードカウントが0になるまでDMAがリクエストされます。

Game Pack DRQビットを設定する場合、カートリッジには/DREQ信号を出力する外部回路が必要です。

DREQと/IREQのピンは1つしかないため、DRQモードを使用している間はカートリッジから/IREQが供給されない可能性があります。

## ビデオキャプチャーモード(DMA3のみ)

>**Warning** 信頼性低

メモリ（または外部ハードウェア/カメラ）から VRAM にビットマップをコピーすることを目的としています。

この転送モードを使用する場合は、リピートビットを設定し、ワードカウントレジスタにスキャンラインあたりのデータ単位数を書き込みます。

キャプチャは HBlank DMA と同様に動作しますが、VCOUNT=2 で転送が開始され、スキャンラインごとに繰り返され、VCOUNT=162 で停止します。

## 転送終了

DMA有効フラグ(bit15)は、転送が完了すると自動的にクリアされます。

サウンドDMA、H/VBlank DMAの場合のみ、プログラマは、転送を停止するためにこのビットを手動でクリアすることもできます。

## 転送にかかる時間

最初のデータ単位をのぞいて、すべてのデータ単位はシーケンシャルな読み書きによって転送されます。

n個のデータ単位があるとき、DMA転送全体に要する時間は、`2N+2(n-1)S+xI` です。

このうち、`1N+(n-1)S`がReadサイクル、残りの`1N+(n-1)S`がWriteサイクルとなりますが、実際のサイクル数は転送元エリアと転送先エリアのWaitStateとバス幅に依存します(CPU命令サイクルタイムの章で説明します)。

さらに、毎回のDMA転送ごとに、 `2I`(通常) か `4I`(転送元と転送先がGamePakメモリのとき)がかかるので、(基本的に)`x` は `2n` か `4n`です。

<sup id="sram">1: データバスが8bit単位に制限されているため、SRAMにはアクセスできません。</sup>
